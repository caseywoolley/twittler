<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/data_generator.js"></script>
  </head>
  <body>

    <header><h1>Twittler</h1></header>
    <nav>
      <ul></ul>
    </nav>
    <div class="container">
      <section>
      <button class="update-tweets"></button>
      <ul class="tweets"></ul>
      </section>
    </div>
    <footer><h3>Twittler</h3></footer>

    <script>
      // home = my tweets + followed

      $(document).ready(function(){

        var $tweets = $('.tweets');
        $tweets.html('');
        var $updateTweets = $('.update-tweets');
        $updateTweets.css({'display' : 'none'});

        var visitor = 'turdferguson';
        streams.users[visitor] = [];
        var newTweets;
        var currentTweets = 0;
        var limit = 20;
        var loaded = false;
        var displayNew = true;
        var hiddenTweets = [];
        var tweetCount = 0; //temporary


        console.log(users);
        console.log(streams);

        $updateTweets.on('click', function(){
          displayNew = true;
          newTweets = hiddenTweets.reverse();
          hiddenTweets = [];
          for (var tweet in newTweets){
            tweetCount += 1; //temporary
            showTweet(newTweets[tweet]);
          }
          $(this).hide();


        });

        var addTweets = function(index, shown){
          while(index >= shown){
            var tweet = streams.home[index];
            if (displayNew){
              tweetCount += 1; //temporary
              showTweet(tweet);
            } else {
              hiddenTweets.push(tweet);
              var s = 's';
              if ( hiddenTweets.length === 1 ) {
                s = '';
                $updateTweets.show();
              }
              $updateTweets.text('Show ' + hiddenTweets.length + ' new tweet' + s);
            }
            index -= 1;
          }
          displayNew = false;
        }

        var checkTweets = function() {
          newTweets = streams.home.length - 1;
          addTweets(newTweets, currentTweets);
          currentTweets = newTweets + 1;
          $tweets.find('li:nth-child(n+' + limit + ')').remove();
          loaded = true;
          setTimeout(checkTweets, 500);
        };

        var showTweet = function(tweet) {
          var $tweet = $('<li>', {
            class: 'tweet'
          });
          var $user = $('<a>', {
            href: '#' + tweet.user,
            class: 'username',
            text: "@" + tweet.user
          });
          var $message = $('<span>', {
            class: 'message',
            text: tweet.message
          });
          var $timeStamp = $('<small>', {
            class: 'time-stamp',
            html: $('<time>', {
              text: tweet.created_at
            })
          });
          var $count = $('<div>', { //temporary
              text: tweetCount
          });
          $tweet
            .append($user)
            .append($message)
            .append($timeStamp)
            .append($count); //temporary
          $tweet.prependTo($tweets);
          if (loaded) {
            $tweet.hide();
            $tweet.slideDown('slow');
          }
        }
        checkTweets();
      });

    </script>
  </body>
</html>
