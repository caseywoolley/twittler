<!DOCTYPE html>
<html>
  <head>
    <title>Twittler</title>
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/data_generator.js"></script>
  </head>
  <body>

    <header><h1>Twittler</h1></header>
    <nav>
      <ul></ul>
    </nav>
    <div class="container">
      <section>
      <button class="update-tweets"></button>
      <ul class="tweets"></ul>
      </section>
    </div>
    <footer><h3>Twittler</h3></footer>

    <script>
      // home = my tweets + followed

      $(document).ready(function(){

        var $tweets = $('.tweets');
        $tweets.html('');
        var $updateTweets = $('.update-tweets');
        $updateTweets.css({'display' : 'none'});
        var initialTweets = streams.home.reverse();
        var userPage = window.location.hash.substr(1);
        var visitor = 'turdferguson';
        streams.users[visitor] = [];
        var newTweets;
        var currentTweets = 0;
        var limit = 20;
        var loaded = false;
        var hiddenTweets = [];
        var tweetCount = 0; //temporary

        console.log(userPage);
        console.log(users);
        console.log(streams);

        //TODO: add click event for username link to show their feed + return home button

        $updateTweets.on('click', function(){
          showTweets(hiddenTweets);
        });

        var addTweets = function(all, shown){

          //store new tweets to be displayed later
          while(all > shown){
            var tweet = streams.home[all];
            if (loaded){ hiddenTweets.push(tweet) }
            var s = 's';
            var hiddenCount = hiddenTweets.length;
            if ( hiddenTweets.length === 1 ) {
              s = '';
              $updateTweets.show();
            }

            //update button text
            $updateTweets.text('Show ' + (hiddenTweets.length > 99 ? '100+' : hiddenTweets.length) + ' new tweet' + s);
            all -= 1;
          }
        }

        var checkTweets = function() {
          newTweets = streams.home.length - 1;
          addTweets(newTweets, currentTweets);
          currentTweets = newTweets;
          $tweets.find('li:nth-child(n+' + limit + ')').remove();
          loaded = true;
          setTimeout(checkTweets, 500);
        };

        var showTweets = function(tweets) {
          var pagebreak = Math.min(tweets.length, limit);
          for (var i = 0; i < pagebreak; i++){
            showTweet(tweets[i]);
          }
          hiddenTweets = [];
          $updateTweets.hide();
        }

        var showTweet = function(tweet) {
          tweetCount += 1; //temporary
          tweet.count = tweetCount; //temporary

          var $tweet = $('<li>', {
            class: 'tweet'
          });
          var $user = $('<a>', {
            href: '#' + tweet.user,
            class: 'username',
            text: "@" + tweet.user
          });
          var $message = $('<span>', {
            class: 'message',
            text: tweet.message
          });
          var $timeStamp = $('<small>', {
            class: 'time-stamp',
            html: $('<time>', {
              text: tweet.created_at
            })
          });
          var $count = $('<div>', { //temporary
              text: tweet.count
          });
          $tweet
            .append($user)
            .append($message)
            .append($timeStamp)
            .append($count); //temporary
          $tweet.prependTo($tweets);
          if (loaded) {
            $tweet.hide();
            $tweet.slideDown('slow');
          }
        }
        showTweets(initialTweets);
        checkTweets();
      });

    </script>
  </body>
</html>
